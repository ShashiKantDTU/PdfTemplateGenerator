<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Medical Laboratory Report</title>
    <!-- Google Fonts: Inter for professional medical reports -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            overflow: visible;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 10pt;
            color: #000;
            line-height: 1.4;
            position: relative;
            background: transparent;
        }
        
        .MainContainer {
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        /* Test Results Section */
        .test-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        /* Department Header */
        .department-header {
            font-size: 11pt;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 3px;
            letter-spacing: 0.5px;
            padding-top: 0;
        }
        
        /* Test Name */
        .test-name {
            font-size: 10pt;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }
        
        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 9pt;
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
        }
        
        .results-table thead {
            background-color: #e8e8e8;
        }
        
        .results-table th {
            padding: 4px 10px;
            text-align: left;
            font-weight: bold;
            color: #000;
            font-size: 8.5pt;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none;
            border-bottom: 2px solid #000;
        }
        
        .results-table th.center {
            text-align: center;
        }
        
        .results-table th.right {
            text-align: right;
        }
        
        .results-table tbody tr {
            border: none;
        }
        
        .results-table td {
            padding: 1px 10px;
            color: #000;
            border: none;
            vertical-align: middle;
        }
        
        .results-table td.center {
            text-align: center;
        }
        
        .results-table td.right {
            text-align: right;
        }
        
        /* Group Headers */
        .group-row {
            background-color: transparent;
            font-weight: normal;
        }
        
        .group-row td {
            padding: 1px 10px;
            font-size: 9pt;
        }
        
        /* Indentation for nested fields */
        .indent-1 { padding-left: 25px !important; }
        .indent-2 { padding-left: 45px !important; }
        .indent-3 { padding-left: 65px !important; }
        
        /* Abnormal Value Styling - Bold red for entire row */
        .abnormal-row {
            font-weight: bold;
        }
        
        .abnormal {
            color: #d32f2f !important;
        }

        .abnormal-low {
            color: #1976d2 !important;
        }

        .abnormal-high {
            color: #d32f2f !important;
        }
        
        /* HTML Content Styling */
        .html-content {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #000;
            margin-bottom: 10px;
        }
        
        .html-content table {
            margin: 10px 0;
            border: 1px solid #000;
        }
        
        .html-content p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .html-content strong {
            color: #000;
        }
        
        /* Page Break Control */
        .page-break-before {
            page-break-before: always;
        }
        
        .no-page-break {
            page-break-inside: avoid;
        }
        
        /* Ending Line */
        .ending-line {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            color: #333;
            font-style: italic;
            line-height: 1.6;
            font-size: 10px;
        }
    </style>
    <style>
        /* Dynamic font size for ending line - separate style block to avoid linter issues */
        .ending-line { font-size: {{reportSettings.endingLineFontSize}}px; }
    </style>
</head>
<body>
    <div class="MainContainer">
        
        <!-- Test Results -->
        {{#each tests}}
        <div class="test-section no-page-break">
            <!-- Department/Category Header -->
            <div class="department-header">{{this.category}}</div>
            
            <!-- Test Name -->
            <div class="test-name">{{this.testName}}</div>
            
            {{#if (eq this.inputType 'text')}}
            <!-- Text tests render content directly without table -->
            {{#each this.fields}}
                {{#if (eq this.type 'field')}}
                    {{#if this.value}}
                        {{{this.displayValue}}}
                    {{/if}}
                {{/if}}
            {{/each}}
            {{else if (eq this.inputType 'select')}}
            <!-- Select tests render content directly without table -->
            {{#each this.fields}}
                {{#if (eq this.type 'field')}}
                    {{#if this.value}}
                        {{{this.displayValue}}}
                    {{/if}}
                {{/if}}
            {{/each}}
            {{else}}
            <!-- Default: Numeric tests use table format -->
            <!-- First, render any HTML content fields outside the table -->
            {{#each this.fields}}
                {{#if (eq this.type 'field')}}
                    {{#if this.value}}
                        {{#if (contains this.displayValue '<table')}}
                            {{{this.displayValue}}}
                        {{/if}}
                    {{/if}}
                {{/if}}
            {{/each}}
            
            <!-- Then render the numeric table with non-HTML fields (only if there are non-HTML fields) -->
            {{#hasNonHtmlFields this.fields}}
            <table class="results-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Test Description</th>
                        <th class="center" style="width: 15%;">Result</th>
                        <th class="center" style="width: 10%;">Flag</th>
                        <th class="center" style="width: 20%;">Ref. Range</th>
                        <th class="center" style="width: 15%;">Unit</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each this.fields}}
                        {{#if (eq this.type 'field')}}
                            {{#if this.value}}
                                {{#unless (contains this.displayValue '<table')}}
                                    <tr {{#if this.isAbnormal}}class="abnormal-row"{{/if}}>
                                        <td>{{this.name}}</td>
                                        <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                            {{this.value}}
                                        </td>
                                        <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                            {{#if this.isAbnormal}}
                                                {{#if (eq this.abnormalType 'high')}}H{{/if}}
                                                {{#if (eq this.abnormalType 'low')}}L{{/if}}
                                            {{/if}}
                                        </td>
                                        <td class="center">{{this.referenceRange}}</td>
                                        <td class="center">{{this.unit}}</td>
                                    </tr>
                                {{/unless}}
                            {{/if}}
                        {{else if (eq this.type 'group')}}
                            <tr class="group-row">
                                <td colspan="5">{{this.name}}</td>
                            </tr>
                            {{#each this.sub_fields}}
                                {{#if (eq this.type 'field')}}
                                    {{#if this.value}}
                                        <tr {{#if this.isAbnormal}}class="abnormal-row"{{/if}}>
                                            <td class="indent-1">{{this.name}}</td>
                                            <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                                {{this.value}}
                                            </td>
                                            <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                                {{#if this.isAbnormal}}
                                                    {{#if (eq this.abnormalType 'high')}}H{{/if}}
                                                    {{#if (eq this.abnormalType 'low')}}L{{/if}}
                                                {{/if}}
                                            </td>
                                            <td class="center">{{this.referenceRange}}</td>
                                            <td class="center">{{this.unit}}</td>
                                        </tr>
                                    {{/if}}
                                {{else if (eq this.type 'group')}}
                                    <tr class="group-row">
                                        <td colspan="5" class="indent-1">{{this.name}}</td>
                                    </tr>
                                    {{#each this.sub_fields}}
                                        {{#if this.value}}
                                            <tr {{#if this.isAbnormal}}class="abnormal-row"{{/if}}>
                                                <td class="indent-2">{{this.name}}</td>
                                                <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                                    {{this.value}}
                                                </td>
                                                <td class="center {{#if (eq this.abnormalType 'low')}}abnormal-low{{else if (eq this.abnormalType 'high')}}abnormal-high{{else if this.isAbnormal}}abnormal{{/if}}">
                                                    {{#if this.isAbnormal}}
                                                        {{#if (eq this.abnormalType 'high')}}H{{/if}}
                                                        {{#if (eq this.abnormalType 'low')}}L{{/if}}
                                                    {{/if}}
                                                </td>
                                                <td class="center">{{this.referenceRange}}</td>
                                                <td class="center">{{this.unit}}</td>
                                            </tr>
                                        {{/if}}
                                    {{/each}}
                                {{/if}}
                            {{/each}}
                        {{/if}}
                    {{/each}}
                </tbody>
            </table>
            {{/hasNonHtmlFields}}
            {{/if}}
            
            {{#if this.interpretation.text}}
            <div class="html-content">
                <strong>Interpretation:</strong>
                <p>{{{this.interpretation.text}}}</p>
            </div>
            {{/if}}
        </div>
        {{/each}}
        
        <!-- Ending Line -->
        {{#if reportSettings.endingLine}}
        <div class="ending-line">
            {{{reportSettings.endingLineHtml}}}
        </div>
        {{/if}}
        
    </div>
    
    <script>
        // Register Handlebars helpers
        if (typeof Handlebars !== 'undefined') {
            // Equality check
            Handlebars.registerHelper('eq', function(a, b) {
                return a === b;
            });
            
            // Contains check (for HTML detection)
            Handlebars.registerHelper('contains', function(str, substr) {
                if (!str) return false;
                return str.includes(substr);
            });
            
            // Unless helper (inverse of if)
            Handlebars.registerHelper('unless', function(conditional, options) {
                if (!conditional) {
                    return options.fn(this);
                } else {
                    return options.inverse(this);
                }
            });
            
            // Check if fields array has any non-HTML fields
            Handlebars.registerHelper('hasNonHtmlFields', function(fields, options) {
                if (!fields || !Array.isArray(fields)) return options.inverse(this);
                
                // Recursively check for non-HTML fields
                const hasNonHtml = (fieldsArray) => {
                    for (let field of fieldsArray) {
                        if (field.type === 'field' && field.value) {
                            // If it's a field with value but no HTML table, return true
                            if (!field.displayValue || !field.displayValue.includes('<table')) {
                                return true;
                            }
                        } else if (field.type === 'group' && field.sub_fields) {
                            // Recursively check sub_fields
                            if (hasNonHtml(field.sub_fields)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                
                if (hasNonHtml(fields)) {
                    return options.fn(this);
                } else {
                    return options.inverse(this);
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Medical Report Template loaded successfully');
        });
    </script>
</body>
</html>
